## 下载linux源码

```
wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.16.3.tar.xz # 可能直接下载更快些
xz -d linux-4.16.3.tar.xz
tar -xf linux-4.16.3.tar
```

## 安装依赖包

```
sudo apt install imagemagick graphviz dvipng librsvg2-bin virtualenv texlive-xetex python3-sphinx python3-sphinx qemu libncurses5-dev gcc-arm-linux-gnueabi build-essential gcc-5-arm-linux-gnueabi gdb-multiarch
```

## 制作最小文件系统 busybox

```
cd busybox
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabi-
make menuconfig

busybox settings -->
    build options -->
        build static library

make && make install
```

## 配置文件系统

```
cp -r busybox/_install linux/
cd linux/_install # 以下可复制 begin
mkdir etc dev mnt -p etc/init.d/
touch etc/init.d/rcS etc/fstab /etc/inittab
chmod +x etc/init.d/rcS
cat>>etc/init.d/rcS<<EOF
mkdir -p /proc
mkdir -p /tmp
mkdir -p /sys
mkdir -p /mnt
/bin/mount -a
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts
echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s
EOF
cat>>etc/fstab<<EOF
proc /proc proc defaults 0 0
tmpfs /tmp tmpfs defaults 0 0
sysfs /sys sysfs defaults 0 0
tmpfs /dev tmpfs defaults 0 0
debugfs /sys/kernel/debug debugfs defaults 0 0
EOF
cat>>etc/inittab<<EOF
::sysinit:/etc/init.d/rcS
::respawn:-/bin/sh
::askfirst:-/bin/sh
::ctrlaltdel:/bin/umount -a -r
EOF
cd dev
sudo mknod console c 5 1
sudo mknod null c 1 3 
# 以下可复制 end
```

## 编译内核

```
cd linux

# 配置 initramfs
General setup   -->
    Initial RAM filesystem and RAM disk(initramfs/initrd) support
    (_install) initramfs source file(s)
    填入"_install"

# 清空默认内核命令字符
Boot options    -->
    ()Default kernel command string

# 配置 memory split 为"3G/1G user/kernel split" 并打开高端内存

Kernel Features -->
Memory split (3G/1G user/kernel split)  -->
[ *] High Memory Support # 此步不要忽略

# 退出,保存,开始编译
make bzImage -j4 ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
make dtbs
```

## qemu 运行

```
// 直接运行
qemu-system-arm -M vexpress-a9 -smp 4 -m 200M -kernel arch/arm/boot/zImage -append "rdinit=/linuxrc console=ttyAMA0 loglevel=8" -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb -nographic
```




## qemu+gdb 调试
```
// qemu 选项
qemu-system-arm  -nographic -M vexpress-a9 -m 1024M -kernel arch/arm/boot/zImage -append "rdinit=/linuxrc console=ttyAMA0 loglevel=8" -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb -S -s
// gdb 选项
cd linux
gdb-multiarch --tui vmlinux 
(gdb)set architecture arm
(gdb)target remote localhost:1234

```